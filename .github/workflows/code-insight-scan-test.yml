name: Code Insight Scan Test

on:
  workflow_dispatch:  # Manual trigger for testing
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sca-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Trigger Code Insight Scan
        id: trigger-scan
        env:
          CI_TOKEN: ${{ secrets.CODE_INSIGHT_TOKEN }}
          PROJECT_ID: 75
        run: |
          echo "ğŸš€ Triggering scan for Project ID: ${PROJECT_ID}"
          
          RESPONSE=$(curl -s -X POST \
            "https://demo.mycodeinsight.com/codeinsight/api/scanResource/projectScan/${PROJECT_ID}" \
            -H "Authorization: Bearer ${CI_TOKEN}" \
            -H "Content-Type: application/json")
          
          echo "=== Full Response ==="
          echo "$RESPONSE"
          echo "===================="
          
          # Try different field names for job ID
          JOB_ID=$(echo "$RESPONSE" | jq -r '.Content // .content // .jobId // .taskId // .id // empty' 2>/dev/null)
          
          if [ -z "$JOB_ID" ] || [ "$JOB_ID" == "null" ]; then
            echo "âš ï¸ Could not extract job ID from response"
            echo "Trying to extract number from response..."
            # Try to extract just the number
            JOB_ID=$(echo "$RESPONSE" | grep -oP '\d+' | head -1)
          fi
          
          if [ -z "$JOB_ID" ]; then
            echo "âŒ Still could not extract job ID"
            echo "Full response: ${RESPONSE}"
            exit 1
          fi
          
          echo "âœ… Scan triggered successfully"
          echo "Job ID: ${JOB_ID}"
          echo "job_id=${JOB_ID}" >> $GITHUB_OUTPUT
      
      - name: Wait for Scan Completion
        id: wait-scan
        env:
          CI_TOKEN: ${{ secrets.CODE_INSIGHT_TOKEN }}
          JOB_ID: ${{ steps.trigger-scan.outputs.job_id }}
        run: |
          echo "â³ Waiting for scan to complete (Job ID: ${JOB_ID})"
          
          MAX_ATTEMPTS=40  # 40 attempts * 30 seconds = 20 minutes max
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Polling attempt ${ATTEMPT}/${MAX_ATTEMPTS}..."
            
            RESPONSE=$(curl -s \
              "https://demo.mycodeinsight.com/codeinsight/api/jobs/${JOB_ID}" \
              -H "Authorization: Bearer ${CI_TOKEN}")
            
            echo "Response: ${RESPONSE}"
            
            # Check for common status field names
            STATUS=$(echo "$RESPONSE" | jq -r '.status // .state // .jobStatus // empty' | tr '[:upper:]' '[:lower:]')
            
            echo "Current status: ${STATUS}"
            
            # Check for completion
            if [[ "$STATUS" == "completed" ]] || [[ "$STATUS" == "success" ]] || [[ "$STATUS" == "finished" ]]; then
              echo "âœ… Scan completed successfully!"
              exit 0
            fi
            
            # Check for failure
            if [[ "$STATUS" == "failed" ]] || [[ "$STATUS" == "error" ]]; then
              echo "âŒ Scan failed"
              echo "Full response: ${RESPONSE}"
              exit 1
            fi
            
            # Still running, wait and retry
            sleep 30
          done
          
          echo "â±ï¸ Scan timed out after ${MAX_ATTEMPTS} attempts"
          exit 1
      
      - name: Fetch Scan Results
        id: fetch-results
        env:
          CI_TOKEN: ${{ secrets.CODE_INSIGHT_TOKEN }}
          PROJECT_ID: 75
        run: |
          echo "ğŸ“Š Fetching scan results..."
          
          RESPONSE=$(curl -s \
            "https://demo.mycodeinsight.com/codeinsight/api/project/inventory/${PROJECT_ID}" \
            -H "Authorization: Bearer ${CI_TOKEN}")
          
          echo "Saving results to codeinsight-results.json"
          echo "$RESPONSE" > codeinsight-results.json
          
          # Parse the response structure: {projectId, projectName, inventoryItems: [...]}
          PROJECT_NAME=$(echo "$RESPONSE" | jq -r '.projectName // "Unknown"')
          echo "Project: ${PROJECT_NAME}"
          
          # Count total inventory items
          TOTAL_COMPONENTS=$(echo "$RESPONSE" | jq '.inventoryItems | length')
          echo "Total components scanned: ${TOTAL_COMPONENTS}"
          
          # Count vulnerabilities by severity
          CRITICAL=$(echo "$RESPONSE" | jq '[.inventoryItems[].vulnerabilities[] | select(.vulnerabilityCvssV3Severity == "CRITICAL")] | length')
          HIGH=$(echo "$RESPONSE" | jq '[.inventoryItems[].vulnerabilities[] | select(.vulnerabilityCvssV3Severity == "HIGH")] | length')
          MEDIUM=$(echo "$RESPONSE" | jq '[.inventoryItems[].vulnerabilities[] | select(.vulnerabilityCvssV3Severity == "MEDIUM")] | length')
          LOW=$(echo "$RESPONSE" | jq '[.inventoryItems[].vulnerabilities[] | select(.vulnerabilityCvssV3Severity == "LOW")] | length')
          
          # Total unique vulnerabilities
          TOTAL_VULNS=$(echo "$RESPONSE" | jq '[.inventoryItems[].vulnerabilities[]] | length')
          
          echo "Vulnerabilities by severity:"
          echo "  Critical: ${CRITICAL}"
          echo "  High: ${HIGH}"
          echo "  Medium: ${MEDIUM}"
          echo "  Low: ${LOW}"
          echo "  Total: ${TOTAL_VULNS}"
          
          # Output for next steps
          echo "total_components=${TOTAL_COMPONENTS}" >> $GITHUB_OUTPUT
          echo "total_vulnerabilities=${TOTAL_VULNS}" >> $GITHUB_OUTPUT
          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT
          echo "low=${LOW}" >> $GITHUB_OUTPUT
      
      - name: Display Summary
        run: |
          echo "## ğŸ” Code Insight Scan Summary"
          echo ""
          echo "- **Project ID:** 75"
          echo "- **Job ID:** ${{ steps.trigger-scan.outputs.job_id }}"
          echo "- **Components Scanned:** ${{ steps.fetch-results.outputs.total_components }}"
          echo ""
          echo "### Vulnerabilities Found"
          echo "| Severity | Count |"
          echo "|----------|-------|"
          echo "| ğŸ”´ Critical | ${{ steps.fetch-results.outputs.critical }} |"
          echo "| ğŸŸ  High | ${{ steps.fetch-results.outputs.high }} |"
          echo "| ğŸŸ¡ Medium | ${{ steps.fetch-results.outputs.medium }} |"
          echo "| ğŸŸ¢ Low | ${{ steps.fetch-results.outputs.low }} |"
          echo "| **Total** | **${{ steps.fetch-results.outputs.total_vulnerabilities }}** |"
          echo ""
          echo "âœ… Scan completed successfully!"
      
      - name: Check Policy Thresholds
        env:
          CRITICAL: ${{ steps.fetch-results.outputs.critical }}
          HIGH: ${{ steps.fetch-results.outputs.high }}
        run: |
          echo "ğŸ”’ Checking security policy thresholds..."
          
          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Policy violation: ${CRITICAL} critical vulnerabilities found"
            echo "Critical vulnerabilities must be resolved before merging"
            exit 1
          fi
          
          if [ "$HIGH" -gt 0 ]; then
            echo "âš ï¸ Warning: ${HIGH} high severity vulnerabilities found"
            echo "Consider resolving high severity issues before merging"
            # Uncomment the next line to block on high severity
            # exit 1
          fi
          
          echo "âœ… No critical vulnerabilities found - policy check passed"
      
      - name: Upload Results as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: codeinsight-scan-results
          path: codeinsight-results.json
